name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: macos-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Shellcheck
        run: |
          brew install shellcheck
          find scripts -name "*.sh" -exec shellcheck -x {} \;

      - name: Verify symlink creation
        run: |
          mkdir -p "$HOME/.config/"{sheldon,"karabiner/assets"}
          source scripts/lib/symlinks.sh
          create_dotfiles_symlinks "$(pwd)"

          # Verify symlinks exist and point to correct targets
          readlink ~/.zshrc | grep -q "zsh/.zshrc"
          readlink ~/.zprofile | grep -q "zsh/.zprofile"
          readlink ~/.gitconfig | grep -q "git/config"
          readlink ~/.config/sheldon/plugins.toml | grep -q "zsh/plugins.toml"
          echo "All symlinks OK"

      - name: Verify Sheldon plugins
        run: |
          brew install sheldon
          sheldon lock --update
          echo "Sheldon plugins OK"

      - name: Verify zsh config loads
        run: |
          zsh -c '
            source '"$(pwd)"'/zsh/aliases.zsh
            alias ga | grep -q "git add"
            alias gs | grep -q "git.*status"
            alias dcom | grep -q "docker compose"

            source '"$(pwd)"'/zsh/functions.zsh
            whence -f ghq_fzf_repo > /dev/null
            echo "Zsh config OK"
          '

      - name: Verify .zshrc loads and tool paths
        run: |
          brew install fzf asdf ghq
          DOTFILES_ZSH="$(pwd)/zsh" zsh -c '
            source '"$(pwd)"'/zsh/.zshrc

            # asdf should be loaded
            whence -p asdf > /dev/null || { echo "FAIL: asdf not found"; exit 1; }
            echo "OK: asdf -> $(whence -p asdf)"

            # fzf should be loaded
            whence -p fzf > /dev/null || { echo "FAIL: fzf not found"; exit 1; }
            echo "OK: fzf -> $(whence -p fzf)"

            # fzf key-bindings should be loaded (Ctrl+R widget)
            zle -la | grep -q fzf || { echo "FAIL: fzf key-bindings not loaded"; exit 1; }
            echo "OK: fzf key-bindings loaded"

            # sheldon should be loaded
            whence -p sheldon > /dev/null || { echo "FAIL: sheldon not found"; exit 1; }
            echo "OK: sheldon -> $(whence -p sheldon)"

            # ghq should be loaded
            whence -p ghq > /dev/null || { echo "FAIL: ghq not found"; exit 1; }
            echo "OK: ghq -> $(whence -p ghq)"

            # Ctrl+G binding should exist
            bindkey "^g" | grep -q ghq_fzf_repo || { echo "FAIL: Ctrl+G binding not set"; exit 1; }
            echo "OK: Ctrl+G -> ghq_fzf_repo"

            echo "All tool paths OK"
          '
