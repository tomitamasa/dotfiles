name: macOS

on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'zsh/**'
      - 'git/**'
      - 'karabiner/**'
      - '.github/workflows/**'
  pull_request:
    paths:
      - 'scripts/**'
      - 'zsh/**'
      - 'git/**'
      - 'karabiner/**'
      - '.github/workflows/**'

jobs:
  macOS:
    name: macOS
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          chmod +x scripts/install.sh

      - name: Run dotfiles installation
        run: |
          export CI=true
          export HOMEBREW_NO_AUTO_UPDATE=1
          export HOMEBREW_NO_ENV_HINTS=1
          ./scripts/install.sh

      - name: Verify tools are installed
        run: |
          echo "=== Checking required tools ==="
          which sheldon
          which fzf
          which ghq

      - name: Verify symlinks
        run: |
          echo "=== Checking symlinks ==="
          test -L ~/.zshrc && echo "OK: ~/.zshrc"
          test -L ~/.zprofile && echo "OK: ~/.zprofile"
          test -L ~/.gitconfig && echo "OK: ~/.gitconfig"
          test -L ~/.config/sheldon/plugins.toml && echo "OK: plugins.toml"

          # Verify symlinks point to correct targets
          readlink ~/.zshrc | grep -q "dotfiles/zsh/.zshrc"
          readlink ~/.zprofile | grep -q "dotfiles/zsh/.zprofile"
          readlink ~/.config/sheldon/plugins.toml | grep -q "dotfiles/zsh/plugins.toml"

      - name: Verify Sheldon plugins
        run: |
          echo "=== Checking Sheldon plugins ==="
          sheldon lock --update
          sheldon source > /dev/null

      - name: Test zsh configuration
        run: |
          echo "=== Testing zsh config loads without errors ==="
          zsh -c 'source ~/.zshrc && echo "zshrc loaded OK"'

      - name: Verify aliases
        run: |
          echo "=== Checking aliases ==="
          zsh -c '
            source ~/dotfiles/zsh/aliases.zsh
            # Git aliases
            alias ga | grep -q "git add"
            alias gs | grep -q "git.*status"
            alias gc | grep -q "git commit"
            alias gp | grep -q "git push"
            # Docker aliases
            alias dcom | grep -q "docker compose"
            echo "All aliases OK"
          '

      - name: Verify functions
        run: |
          echo "=== Checking functions ==="
          zsh -c '
            source ~/dotfiles/zsh/functions.zsh
            whence -f ghq_fzf_repo > /dev/null && echo "ghq_fzf_repo OK"
          '
